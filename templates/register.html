@app.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        fullname = request.form.get("fullname")
        email = request.form.get("email")
        password = request.form.get("password")
        confirm = request.form.get("confirm")
        account_type = request.form.get("account_type")

        if password != confirm:
            flash("Passwords do not match")
            return redirect(url_for("register"))

        account_number = "30" + str(random.randint(10000000, 99999999))
        otp = str(random.randint(100000, 999999))

        users[email] = {
            "fullname": fullname,
            "password": password,
            "account": account_number,
            "balance": 10000,
            "otp": otp,
            "verified": False,
            "type": account_type
        }

        # âœ… SAFE EMAIL SEND (NO FREEZE)
        try:
            msg = Message(
                "Scotitrust Bank OTP",
                recipients=[email]
            )
            msg.body = f"Your OTP is {otp}"
            mail.send(msg)
        except Exception as e:
            print("MAIL ERROR:", e)

        session["verify_email"] = email
        return redirect(url_for("verify_otp"))

    return render_template("register.html")
